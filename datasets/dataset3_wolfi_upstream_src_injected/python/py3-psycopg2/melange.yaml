# Generated from https://pypi.org/project/psycopg2/
package:
  name: py3-psycopg2
  version: 2.9.9
  epoch: 1
  description: psycopg2 - Python-PostgreSQL Database Adapter
  copyright:
    - license: LGPL-3.0-or-later
  dependencies:
    runtime:
      - python3

environment:
  contents:
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.wolfi.dev/os
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - postgresql-dev
      - py3-build
      - py3-installer
      - py3-setuptools
      - python3
      - python3-dev
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/lyvd/psycopg2 
      tag: v${{package.version}}
      expected-commit: 3b7386abe280af8ea0bc175597a4d7637196edb5 

  - name: Python Build
    uses: python/build-wheel

  - uses: strip

update:
  enabled: true
  version-separator: _
  github:
    identifier: lyvd/psycopg2
    use-tag: true

test:
  environment:
    contents:
      packages:
        - postgresql
        - postgresql-client
        - wolfi-base
        - shadow
        - sudo-rs
        - glibc-locales
    environment:
      PGDATA: /tmp/test_db
      PGUSER: wolfi
  pipeline:
    - name: "Test database creation"
      runs: |
        useradd $PGUSER
        sudo -u $PGUSER initdb -D /tmp/test_db
        sudo -u $PGUSER pg_ctl -D /tmp/test_db -l /tmp/logfile start
        sudo -u $PGUSER createdb testdb
        psql -lqt | cut -d \| -f 1 | grep -qw testdb
    - name: "Test psycopg2"
    - runs: |
        cat <<'EOF' >> /tmp/test.py
        import psycopg2

        def main():
            conn = psycopg2.connect(dbname="testdb", user="wolfi")
            cursor = conn.cursor()

            try:
                # Create Table
                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS example_table (
                        id SERIAL PRIMARY KEY,
                        message TEXT
                    )
                """)

                # Insert value
                cursor.execute("INSERT INTO example_table (message) VALUES (%s)", ("Hello Wolfy!",))
                conn.commit()

                # Select and print
                cursor.execute("SELECT message FROM example_table")
                result = cursor.fetchone()
                message = result[0]
                print("Message retrieved from database:", message)

            except Exception as e:
                print("Error:", e)

            finally:
                cursor.close()
                conn.close()

        if __name__ == "__main__":
            main()
        EOF
        python3 /tmp/test.py
